"use strict";!function(){var taskManager=function(){var taskM={};if(taskM.domTaskArray=[],taskM.addTaskWhenDomLoaded=function(task){taskM.domTaskArray.push(task)},taskM.asyncTask=[],taskM.addAsyncTask=function(task,self,arguArray){taskM.asyncTask.push({task:task,self:self,arguArray:arguArray})},taskM.finishAsyncTask=function(){taskM.asyncTask.shift(),0!==taskM.asyncTask.length&&taskM.asyncTask[0].task.apply(taskM.asyncTask[0].self,taskM.asyncTask[0].arguArray)},taskM.asyncTaskExec=function(){0!==taskM.asyncTask.length&&taskM.asyncTask[0].task.apply(taskM.asyncTask[0].self,taskM.asyncTask[0].arguArray)},null!==window.onload){var currentF=window.onload;taskM.domTaskArray.push(currentF)}return window.onload=function(){for(var i=0;i<taskM.domTaskArray.length;i++)taskM.domTaskArray[i]()},taskM}();"undefined"!=typeof module&&"undefined"!=typeof module.exports?module.exports=taskManager:"function"==typeof define&&define.amd?define([],function(){return taskManager}):window.taskManager=taskManager}(),function(){var postman=function(){function load(url,pfnError){var script=document.createElement("script"),done=!1;script.src=url,script.async=!0;var errorHandler=pfnError||config.error;"function"==typeof errorHandler&&(script.onerror=function(ex){errorHandler({url:url,event:ex})}),script.onload=script.onreadystatechange=function(){done||this.readyState&&"loaded"!==this.readyState&&"complete"!==this.readyState||(done=!0,script.onload=script.onreadystatechange=null,script&&script.parentNode&&script.parentNode.removeChild(script))},head||(head=document.getElementsByTagName("head")[0]),head.appendChild(script)}function encode(str){return encodeURIComponent(str)}function jsonp(url,params,callback,callbackName){var key,query=-1===(url||"").indexOf("?")?"?":"&";callbackName=callbackName||config.callbackName||"callback";var uniqueName=callbackName+"_json"+ ++counter;params=params||{};for(key in params)params.hasOwnProperty(key)&&(query+=encode(key)+"="+encode(params[key])+"&");return window[uniqueName]=function(data){callback(data);try{delete window[uniqueName]}catch(e){}window[uniqueName]=null},load(url+query+callbackName+"="+uniqueName),uniqueName}function setDefaults(obj){config=obj}var head,counter=0,config={};return{get:jsonp,init:setDefaults}}();"undefined"!=typeof module&&"undefined"!=typeof module.exports?module.exports=postman:"function"==typeof define&&define.amd?define([],function(){return postman}):window.postman=postman}(),function(taskManager,postman){var basicDataCollector=function(taskManager,postman){var collector={};return collector.browser=function(){var browser={platform:"",type:""};taskManager.addAsyncTask(function(userAgent){var self=this;postman.get("http://mrpeach.me:3458",{userAgent:userAgent},function(data){self.platform=data.os.family+" "+data.os.version,self.type=data.name+" "+data.version,taskManager.finishAsyncTask()})},browser,[navigator.userAgent]),browser.language=navigator.language||navigator.userLanguage||navigator.systemLanguage;var parse_url=/^(?:([A-Za-z]+):)?(\/{0,3})([0-9.\-A-Za-z]+)(?::(\d+))?(?:\/([^?#]*))?(?:\?([^#]*))?(?:#(.*))?$/;return browser.url=parse_url.exec(document.URL),browser}(),collector.interactionNodeList=[],collector.interaction=function(element,event,callback){function eventHappen(node){return function(){var currentE=null;null!==node[event]&&(currentE=node[event]),node[event]=function(){null!==currentE&&currentE();var re={TargetTag:node.tagName,TargetId:node.id,TargetClass:node.className,InnerContent:node.innerText,Type:event,Time:(new Date).getTime(),Domain:collector.browser.url[3],Path:collector.browser.url[5],Hash:collector.browser.url[7]||"",Query:collector.browser.url[6]||""};callback(re)}}()}taskManager.addTaskWhenDomLoaded(function(){var node=null,nodeList=null;if(void 0!==element.id?(node=document.getElementById(element.id),collector.interactionNodeList.push(node)):void 0!==element.className?(nodeList=document.getElementsByClassName(element.className),collector.interactionNodeList.concat(nodeList)):(nodeList=document.getElementsByTagName(element.element),collector.interactionNodeList.concat(nodeList)),null!==node)eventHappen(node);else if(null!==nodeList)for(var i=0;i<nodeList.length;i++)eventHappen(nodeList[i])})},collector.geoLocation=function(){var geoLocation={};return taskManager.addAsyncTask(function(){var self=this;postman.get("http://ipinfo.io",null,function(data){self.city=data.city,self.region=data.region,self.country=data.country,self.ip=data.ip,taskManager.finishAsyncTask()})},geoLocation),geoLocation}(),console.log("Here is basicDataCollector object",collector),collector}(taskManager,postman);"undefined"!=typeof module&&"undefined"!=typeof module.exports?module.exports=basicDataCollector:"function"==typeof define&&define.amd?define([],function(){return basicDataCollector}):window.basicDataCollector=basicDataCollector}(taskManager,postman),function(taskManager,basicDataCollector,postman){var cookiesManager=function(taskManager,basicDataCollector,postman){var cookiesM={};return cookiesM.currentUser=window.localStorage.getItem("nwuUC"),cookiesM.joindate=window.localStorage.getItem("nwjd"),cookiesM.currentUser?cookiesM.userType="existing":(cookiesM.userType="new",taskManager.addAsyncTask(function(basicData){var req=basicData.browser.platform+basicData.browser.type+basicData.browser.language+basicData.geoLocation.ip+(new Date).toString();postman.get("http://jssha.mrpeach.me",{text:req,type:"TEXT"},function(data){cookiesM.currentUser=data.hash,cookiesM.joindate=(new Date).getTime(),window.localStorage.setItem("nwuUC",cookiesM.currentUser),window.localStorage.setItem("nwjd",cookiesM.joindate),taskManager.finishAsyncTask()})},cookiesM,[basicDataCollector])),console.log("Here is cookiesM object",cookiesM),cookiesM}(taskManager,basicDataCollector,postman);"undefined"!=typeof module&&"undefined"!=typeof module.exports?module.exports=cookiesManager:"function"==typeof define&&define.amd?define([],function(){return cookiesManager}):window.cookiesManager=cookiesManager}(taskManager,basicDataCollector,postman),function(basicDataCollector,cookiesManager,taskManager,postman){var nightsWatcher=function(basicDataCollector,cookiesManager,taskManager,postman){var watcher={user:null,visit:{},events:[],configObj:{}};return watcher.config=function(configObject){watcher.configObj=configObject},watcher.identify=function(arg1,arg2){taskManager.addAsyncTask(function(arg1,arg2){var obj={Platform:basicDataCollector.browser.platform,Browser:basicDataCollector.browser.type,Language:basicDataCollector.browser.language,Country:basicDataCollector.geoLocation.country,City:basicDataCollector.geoLocation.city,Region:basicDataCollector.geoLocation.region};"function"==typeof arg1?(watcher.user=obj,arg1(obj)):"user"===arg1&&(obj.UserId=cookiesManager.currentUser,obj.JoinDate=cookiesManager.joindate,watcher.user=obj,watcher.visit.UserId=obj.UserId,arg2(obj,cookiesManager.userType)),taskManager.finishAsyncTask()},null,[arg1,arg2])},watcher.on=function(directive,callback){if("visitingStart"===directive){var startDate=(new Date).getTime();watcher.visit={Time:startDate,Site:basicDataCollector.browser.url[3]},callback(watcher.visit)}},watcher.track=function(element,event,callback){basicDataCollector.interaction(element,event,function(trackedEvent){trackedEvent.UserId=watcher.user.UserId,watcher.events.push(trackedEvent),callback(trackedEvent)})},watcher.run=function(){taskManager.addAsyncTask(function(){var self=this;self.user.type=1,self.user.token=self.configObj.domainToken,self.visit.type=2,self.visit.token=self.configObj.domainToken,postman.get(self.configObj.server,self.user,function(){postman.get(self.configObj.server,self.visit,function(data){self.visit.VisitId=data._id,taskManager.finishAsyncTask()})})},watcher),taskManager.addAsyncTask(function(){var self=this;self.events.push({Type:"viewpage",Time:(new Date).getTime(),Domain:basicDataCollector.browser.url[3],Path:basicDataCollector.browser.url[5],Hash:basicDataCollector.browser.url[7]||"",Query:basicDataCollector.browser.url[6]||"",UserId:self.user.UserId,TargetTag:"",TargetId:"",TargetClass:"",InnerContent:""}),taskManager.finishAsyncTask()},watcher),taskManager.addAsyncTask(function(){var self=this;setInterval(function(){for(var i=0;i<self.events.length;i++)self.events[i].VisitId=self.visit.VisitId||"";postman.get(self.configObj.server,{type:3,token:self.configObj.domainToken,data:JSON.stringify(self.events)},function(){self.events=[],taskManager.finishAsyncTask()})},2e3),taskManager.finishAsyncTask()},watcher),taskManager.asyncTaskExec()},watcher}(basicDataCollector,cookiesManager,taskManager,postman);"undefined"!=typeof module&&"undefined"!=typeof module.exports?module.exports=nightsWatcher:"function"==typeof define&&define.amd?define([],function(){return nightsWatcher}):window.nightsWatcher=nightsWatcher}(basicDataCollector,cookiesManager,taskManager,postman);